const auth=firebase.auth();const db=firebase.firestore();
async function isFirstUser(){const s=await db.collection('users').limit(1).get();return s.empty;}
window.registerUser=async function(ev){ev&&ev.preventDefault();const f=ev.target.closest('form')||document.querySelector('#registerForm');const name=f.name.value.trim();const email=f.email.value.trim();const password=f.password.value;const jabatan=f.jabatan.value||'Anggota';const bidang=f.bidang.value||'-';const file=f.photo.files[0];const cred=await auth.createUserWithEmailAndPassword(email,password);const uid=cred.user.uid;let role='anggota_umum';if(await isFirstUser()) role='admin_super';let photoURL='';if(file){photoURL=await uploadImage(file);}await db.collection('users').doc(uid).set({name,email,role,jabatan,bidang,photoURL,joinedAt:firebase.firestore.FieldValue.serverTimestamp()});localStorage.setItem('userRole',role);window.location.href='dashboard.html';};
window.loginUser=async function(ev){ev&&ev.preventDefault();const f=ev.target.closest('form')||document.querySelector('#loginForm');const email=f.email.value.trim();const password=f.password.value;await auth.signInWithEmailAndPassword(email,password);const uid=auth.currentUser.uid;const data=(await db.collection('users').doc(uid).get()).data();localStorage.setItem('userRole',data?.role||'anggota_umum');window.location.href='dashboard.html';};
window.logoutUser=async function(){await auth.signOut();localStorage.removeItem('userRole');window.location.href='index.html';};
window.addEventListener('DOMContentLoaded',async()=>{const isDash=location.pathname.endsWith('dashboard.html');firebase.auth().onAuthStateChanged(async(u)=>{if(isDash){if(!u){location.href='login.html';return;}const doc=await db.collection('users').doc(u.uid).get();const us=doc.data()||{};const photo=document.querySelector('#userPhoto');const uname=document.querySelector('#userName');const urole=document.querySelector('#userRole');if(photo) photo.src=us.photoURL||'assets/img/avatar.png';if(uname) uname.textContent=us.name||u.email;if(urole) urole.textContent=(us.jabatan||'Anggota')+' â€¢ '+(us.role||'anggota_umum');Roles.apply(us.role||'anggota_umum');const hash=location.hash.replace('#','')||'home';Dashboard.load(hash);document.querySelectorAll('[data-menu]').forEach(a=>{a.onclick=(e)=>{e.preventDefault();const key=a.getAttribute('data-menu');if(Roles.can(key,us.role)){Dashboard.load(key);document.querySelectorAll('[data-menu]').forEach(x=>x.classList.remove('active'));a.classList.add('active');history.replaceState(null,'','#'+key);}});}});});
